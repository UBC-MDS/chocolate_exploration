---
title: "EDA_Manvir"
author: "Manvir Kohli"
date: "2022-11-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Loading libraries

```{r}
library(dplyr)
library(tidyverse)
```

```{r}
eda_data <- read_csv("../raw/train_df.csv")
dim(eda_data)
head(eda_data)
tail(eda_data)
```

Looks like the data has been read properly. We have 1771 examples over 9 features and 1 target. Below we see check the structure and the summary statistics for our data

```{r}
str(eda_data)
```

- our target variable is rating
- the columns "ref" and "specific_bean_origin_or_bar_name" are identifier columns and should be dropped 
- the columns "manufacturer","company_location","country_of_bean_origin","ingredients","most_memorable_characteristics" are all read as character columns but should ideally be factors (categorical columns)
- "cocoa_percent" is read as a character and should be numeric

We need  convert all the columns to the correct data types but we will do that later


```{r}
length(unique(eda_data$most_memorable_characteristics))
```

We can see that the most_memorable_characteristics seem to be very unique for each kind of chocolate and have 1755 different unique values, so we can drop this feature. Additionally, the ingredients column has 2 components to it - the number of ingredients and the actual ingredients.  So we can split this column into 2 and have 2 separate features. into So we now have total 7 features. We further check our columns for nulls

```{r}
eda_data_converted <- eda_data |> select(-c(ref,specific_bean_origin_or_bar_name,most_memorable_characteristics)) |> 
                    separate(col=ingredients,sep ="-",into = c('num_of_ingredients','ingredients'))
head(eda_data_converted)

eda_data_converted |> summarise(across(everything(), ~ sum(is.na(.))))
```

we see that there are 66 examples with missing values in our ingredients and num_of_ingredients columns


#### Exploring factor like columns further

```{r}
eda_data_converted |> group_by(company_manufacturer) |> summarize(count = n()) |> arrange(-count) 
eda_data_converted |> group_by(company_location) |> summarize(count = n()) |> arrange(-count)
eda_data_converted |> group_by(country_of_bean_origin) |> summarize(count = n()) |> arrange(-count)
eda_data_converted |> group_by(ingredients) |> summarize(count = n()) |> arrange(-count)

```

For all the factors there are many levels. We can reduce the number of levels for different factors as follows :
- for company_manufacturer keep only the top 20 manufacturers and combine all other manufacturers into "Other"
- for company_location keep only the top 10 locations and combine all other locations into "Other"
- for country_of_bean_origin keep only the top 15 countries and combine all other into "Other"
- for ingredients keep the top 5 ingredients and combine all other into "Other"

```{r}
top_20_manufacturers <-  eda_data_converted |> group_by(company_manufacturer) |> summarize(count = n()) |> arrange(-count) |> 
            top_n(20) |> pull(company_manufacturer)

top_10_locations <-  eda_data_converted |> group_by(company_location) |> summarize(count = n()) |> arrange(-count) |> 
            top_n(10) |> pull(company_location)

top_15_countries <-  eda_data_converted |> group_by(country_of_bean_origin) |> summarize(count = n()) |> arrange(-count) |> 
            top_n(15) |> pull(country_of_bean_origin)

top_5_ingredients <-  eda_data_converted |> group_by(ingredients) |> summarize(count = n()) |> arrange(-count) |> 
            top_n(5) |> pull(ingredients)

top_20_manufacturers <-  as.vector(top_20_manufacturers)
top_10_locations <-  as.vector(top_10_locations)
top_15_countries <-  as.vector(top_15_countries)
top_5_ingredients <- as.vector(top_5_ingredients)

```

```{r}
eda_data_converted <- eda_data_converted |>
    mutate(company_manufacturer= case_when(!company_manufacturer %in% top_20_manufacturers ~ "Other",
                            TRUE ~ company_manufacturer),
         company_location = case_when(!company_location %in% top_10_locations ~ "Other",
                             TRUE ~ company_location) ,
         country_of_bean_origin = case_when(!country_of_bean_origin %in% top_15_countries ~ "Other",
                             TRUE ~ country_of_bean_origin),
         ingredients = case_when(!ingredients %in% top_5_ingredients ~ "Other",
                             TRUE ~ ingredients)) 


```

##### Now we can convert our character columns into factors and also convert cocoa_percent column into a numeric column

```{r}
eda_data_final <-   eda_data_converted |> mutate(
            company_manufacturer = as.factor(company_manufacturer),
            company_location = as.factor(company_location),
            country_of_bean_origin = as.factor(country_of_bean_origin),
            cocoa_percent = str_replace(cocoa_percent,"%",""),
            cocoa_percent = as.numeric(cocoa_percent)/100,
            ingredients = as.factor(ingredients))

head(eda_data_final)
```
